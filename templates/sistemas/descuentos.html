{% extends 'index.html' %}
{% load static %}
{% block contenido %}
<div class="tabla-admin">
    <div class="tabla-admin-header">
        <h1 class="subtitulo-seccion">{{ titulo }}</h1>
        <a href="{% url 'creardescuentos' %}" class="registro-button">Registrar descuento</a>
    </div>

    {% if messages %}
        <div class="dashboard-messages" style="margin-bottom: 1.5rem;">
            {% for message in messages %}
                <p>{{ message }}</p>
            {% endfor %}
        </div>
    {% endif %}

    <section class="discount-builder">
        <div class="discount-builder-card">
            <div>
                <h2>Generador profesional de descuentos QR</h2>
                <p class="discount-builder-subtitle">Crea un beneficio, genera su QR y compártelo con la comunidad.</p>
                <form method="post" class="builder-form">
                    {% csrf_token %}
                    <div class="builder-grid">
                        <div class="form-group{% if builder_form.proveedor.errors %} has-error{% endif %}">
                            {{ builder_form.proveedor.label_tag }}
                            {{ builder_form.proveedor }}
                            {% for error in builder_form.proveedor.errors %}<span class="form-error">{{ error }}</span>{% endfor %}
                        </div>
                        <div class="form-group{% if builder_form.codigo.errors %} has-error{% endif %}">
                            {{ builder_form.codigo.label_tag }}
                            {{ builder_form.codigo }}
                            {% for error in builder_form.codigo.errors %}<span class="form-error">{{ error }}</span>{% endfor %}
                        </div>
                        <div class="form-group{% if builder_form.porcentaje.errors %} has-error{% endif %}">
                            {{ builder_form.porcentaje.label_tag }}
                            {{ builder_form.porcentaje }}
                            {% if builder_form.porcentaje.help_text %}<small>{{ builder_form.porcentaje.help_text }}</small>{% endif %}
                            {% for error in builder_form.porcentaje.errors %}<span class="form-error">{{ error }}</span>{% endfor %}
                        </div>
                        <div class="form-group{% if builder_form.vigencia.errors %} has-error{% endif %}">
                            {{ builder_form.vigencia.label_tag }}
                            {{ builder_form.vigencia }}
                            {% if builder_form.vigencia.help_text %}<small>{{ builder_form.vigencia.help_text }}</small>{% endif %}
                            {% for error in builder_form.vigencia.errors %}<span class="form-error">{{ error }}</span>{% endfor %}
                        </div>
                    </div>
                    <div class="form-group{% if builder_form.descripcion.errors %} has-error{% endif %}">
                        {{ builder_form.descripcion.label_tag }}
                        {{ builder_form.descripcion }}
                        {% for error in builder_form.descripcion.errors %}<span class="form-error">{{ error }}</span>{% endfor %}
                    </div>
                    <button type="submit" class="registro-button">Generar descuento</button>
                </form>
            </div>
            <div class="builder-preview">
                {% if qr_preview %}
                    <p class="builder-preview-label">QR listo para compartir</p>
                    <img src="{{ qr_preview.data_uri }}" alt="QR del descuento" class="builder-preview-img" />
                    <pre class="builder-preview-json">{{ qr_preview.payload_json }}</pre>
                    {% if ultimo_descuento %}
                        <p class="builder-preview-meta">ID generado: {{ ultimo_descuento.id_descuento }} · Código: {{ ultimo_descuento.codigo_qr }}</p>
                    {% endif %}
                {% else %}
                    <p class="builder-preview-placeholder">Completa el formulario para ver el QR y la carga útil que se enviará a los socios.</p>
                {% endif %}
            </div>
        </div>
    </section>

    <div class="tabla-admin-wrapper">
        <table class="tabla-datos">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Proveedor</th>
                    <th>Código</th>
                    <th>Descripción</th>
                    <th>Foto</th>
                    <th style="width: 200px;">Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for descuento in descuentos %}
                    <tr>
                        <td>{{ descuento.id_descuento }}</td>
                        <td>{{ descuento.proveedor.nombre }}</td>
                        <td>{{ descuento.codigo_qr }}</td>
                        <td>{{ descuento.descripcion|truncatechars:60 }}</td>
                        <td>
                            {% if descuento.foto %}
                                <a href="{{ descuento.foto.url }}" class="card-link" target="_blank">Ver imagen</a>
                            {% else %}
                                —
                            {% endif %}
                        </td>
                        <td style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                            <a href="{% url 'editardescuentos' descuento.id_descuento %}" class="card-link">Editar</a>
                            <a href="{% url 'eliminardescuentos' descuento.id_descuento %}" class="card-link" onclick="return confirm('¿Seguro que deseas eliminar este descuento?');">Eliminar</a>
                        </td>
                    </tr>
                {% empty %}
                    <tr>
                        <td colspan="6" class="mensaje-vacio">No hay descuentos registrados.</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}
